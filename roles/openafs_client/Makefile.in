# Copyright (c) 2019-2020 Sine Nomine Associates

.PHONY: help lint test distclean

COOK=@COOKIECUTTER@ \
   --no-input -f -o molecule \
   @TOPDIR@/cookiecutter/molecule-scenario @DRIVER_OPTIONS@ \
   instance_name=@INSTANCE_PREFIX@client \
   with_client=yes

help:
	@echo "usage: make <target>"
	@echo ""
	@echo "targets:"
	@echo "  lint        run lint checks"
	@echo "  test        run molecule scenarios"
	@echo "  molecule    generate molecule scenarios"
	@echo "  reset       reset molecule temporary directories"
	@echo "  clean       remove molecule scenarios"

lint:
	yamllint .
	ansible-lint .

test: molecule
	molecule test --all

molecule: Makefile
	$(COOK) name=default
	$(COOK) name=cen7           os=centos7  im=managed  im_module=dkms
	$(COOK) name=cen7-kmod      os=centos7  im=managed  im_module=kmod
	$(COOK) name=cen7-rpm       os=centos7  im=packages im_module=dkms
	$(COOK) name=cen7-rpm-kmod  os=centos7  im=packages im_module=kmod
	$(COOK) name=cen7-bdist     os=centos7  im=bdist
	$(COOK) name=cen7-sdist     os=centos7  im=sdist
	$(COOK) name=cen7-scm       os=centos7  im=scm
	$(COOK) name=cen8           os=centos8  im=managed  im_module=dkms
	$(COOK) name=cen8-kmod      os=centos8  im=managed  im_module=kmod
	$(COOK) name=cen8-rpm       os=centos8  im=packages im_module=dkms
	$(COOK) name=cen8-rpm-kmod  os=centos8  im=packages im_module=kmod
	$(COOK) name=cen8-bdist     os=centos8  im=bdist
	$(COOK) name=cen8-scm       os=centos8  im=scm
	$(COOK) name=deb9           os=debian9  im=managed
	$(COOK) name=deb9-bdist     os=debian9  im=bdist
	$(COOK) name=deb9-scm       os=debian9  im=scm
	$(COOK) name=deb10          os=debian10 im=managed
	$(COOK) name=deb10-bdist    os=debian10 im=bdist
	$(COOK) name=deb10-scm      os=debian10 im=scm
	touch molecule

reset:
	@if [ -d molecule ]; then \
		for s in `ls molecule`; do \
			molecule reset -s $$s; \
		done \
	fi

clean: reset
	rm -rf molecule
