---
- name: Load OS specific variables
  include_vars: "{{ ansible_os_family|lower }}.yaml"

- name: Include OS specific tasks
  include_tasks: "{{ ansible_os_family|lower }}.yaml"

- name: Configure kerberos kdc
  template:
    src: "{{ item }}.j2"
    dest: "{{ afs_kerberos_localstatedir }}/krb5kdc/{{ item }}"
    owner: root
    group: root
    mode: 0600
  with_items:
  - kdc.conf
  - kadm5.acl
  notify:
    - restart kdc
    - restart kadmin

- name: Create kerberos kdc database
  command: >
    /sbin/kdb5_util
    -P {{ afs_kerberos_master_password }}
    -r {{ afs_realm }}
    create -s
  args:
    creates: "{{ afs_kerberos_localstatedir }}/krb5kdc/principal"
  register: krb5_util_results

- name: Start kerberos kdc
  service:
    name: krb5kdc
    enabled: yes
    state: started

- name: Start kadmin
  service:
    name: kadmin
    enabled: yes
    state: started

- name: Create admin principal
  command: >
    {{ afs_kadmin_local }}
    -r {{ afs_realm }}
    -q "add_principal -pw {{ afs_admin_password }} {{ afs_admin_principal }}@{{ afs_realm }}"
  register: kadmin_results
  changed_when: >
    kadmin_results.rc == 0
    and not "already exists while creating" in kadmin_results.stderr

- name: Create the afs service key
  command: >
    {{ afs_kadmin_local }}
    -r "{{ afs_realm }}"
    -q "add_principal -randkey afs/{{ afs_cell }}@{{ afs_realm }}"
  register: kadmin_results
  changed_when: >
    kadmin_results.rc == 0
    and not "already exists while creating" in kadmin_results.stderr
  when: afs_cell is defined
