---

- name: Install Setools
  yum:
    name:
      - policycoreutils-python
      - setools-console
    state: present

- name: Test for presence of openafs module in SELinux
  shell: semodule -lstandard | grep -q -E '^openafs\s+{{ mod_ver }}$'
  register: module_result
  ignore_errors: True
  no_log: True
  failed_when: no

- name: Copy the SELinux module for openafs server
  copy:
    dest: "/tmp/{{ item }}"
    src: "files/{{ item }}"
  when: module_result.rc > 0
  with_items:
    - openafs.te
    - openafs.fc

- name: Build SELinux module for openafs server
  command: "{{ item }}"
  args:
    chdir: "/tmp"
  when: module_result.rc > 0
  with_items:
    - "checkmodule -M -m -o openafs.mod openafs.te"
    - "semodule_package -o openafs.pp -m openafs.mod -f openafs.fc"
    - "semodule -i openafs.pp"
